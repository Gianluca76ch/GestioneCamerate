<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    
    <!-- ============================================ -->
    <!-- REVERSE PROXY + REACT ROUTER                -->
    <!-- ============================================ -->
    <rewrite>
      <rules>
        
        <!-- REGOLA 1: Reverse Proxy per /api/* → localhost:5000 -->
        <rule name="API Reverse Proxy" stopProcessing="true">
          <match url="^api/(.*)" />
          <action type="Rewrite" url="http://localhost:5000/api/{R:1}" />
          <serverVariables>
            <set name="HTTP_X_ORIGINAL_HOST" value="{HTTP_HOST}" />
            <set name="HTTP_X_ORIGINAL_ACCEPT_ENCODING" value="{HTTP_ACCEPT_ENCODING}" />
          </serverVariables>
        </rule>
        
        <!-- REGOLA 2: React Router (SPA) - Tutte le altre route → index.html -->
        <rule name="React Routes" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <!-- Non rewrite se è un file esistente -->
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <!-- Non rewrite se è una directory esistente -->
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
            <!-- Non rewrite per le API -->
            <add input="{REQUEST_URI}" pattern="^/api" negate="true" />
          </conditions>
          <action type="Rewrite" url="/" />
        </rule>
        
      </rules>
    </rewrite>
    
    <!-- ============================================ -->
    <!-- WINDOWS AUTHENTICATION (OBBLIGATORIA)       -->
    <!-- ============================================ -->
    <security>
      <authentication>
        <windowsAuthentication enabled="true">
          <providers>
            <clear />
            <add value="Negotiate" />
            <add value="NTLM" />
          </providers>
        </windowsAuthentication>
        <anonymousAuthentication enabled="false" />
      </authentication>
    </security>
    
    <!-- ============================================ -->
    <!-- MIME TYPES per React                        -->
    <!-- ============================================ -->
    <staticContent>
      <remove fileExtension=".json" />
      <mimeMap fileExtension=".json" mimeType="application/json" />
      <remove fileExtension=".woff" />
      <mimeMap fileExtension=".woff" mimeType="application/font-woff" />
      <remove fileExtension=".woff2" />
      <mimeMap fileExtension=".woff2" mimeType="font/woff2" />
      <remove fileExtension=".js" />
      <mimeMap fileExtension=".js" mimeType="application/javascript" />
      <remove fileExtension=".css" />
      <mimeMap fileExtension=".css" mimeType="text/css" />
      <remove fileExtension=".svg" />
      <mimeMap fileExtension=".svg" mimeType="image/svg+xml" />
    </staticContent>
    
    <!-- ============================================ -->
    <!-- COMPRESSIONE (per performance)              -->
    <!-- ============================================ -->
    <urlCompression doStaticCompression="true" doDynamicCompression="true" />
    
    <!-- ============================================ -->
    <!-- CACHE per file statici                      -->
    <!-- ============================================ -->
    <caching enabled="true" enableKernelCache="true">
      <profiles>
        <add extension=".js" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
        <add extension=".css" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
        <add extension=".woff" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
        <add extension=".woff2" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
      </profiles>
    </caching>
    
    <!-- ============================================ -->
    <!-- GESTIONE ERRORI                             -->
    <!-- ============================================ -->
    <httpErrors existingResponse="PassThrough" />
    
  </system.webServer>
</configuration>